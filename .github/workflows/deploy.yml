name: Deploy to Kakao Cloud
description: React ì•±ì„ ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œì— ìë™ ë°°í¬

# ì–¸ì œ ì‹¤í–‰í• ì§€ ì„¤ì •
on:
  push:
    branches: [main, develop] # main, develop ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [main, develop] # main, develop ë¸Œëœì¹˜ë¡œ PRì´ ì˜¬ë¼ì˜¬ ë•Œë„ ì‹¤í–‰

# ì‘ì—… ì •ì˜
jobs:
  # í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ì‘ì—…
  test-and-build:
    runs-on: ubuntu-latest # Ubuntu ìµœì‹  ë²„ì „ì—ì„œ ì‹¤í–‰

    steps:
      # 1ë‹¨ê³„: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ë‹¨ê³„: Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3ë‹¨ê³„: ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
      - name: Run linting
        run: npm run lint

      # 5ë‹¨ê³„: íƒ€ì… ê²€ì‚¬
      - name: Type check
        run: npm run type-check

      # 6ë‹¨ê³„: ë¹Œë“œ
      - name: Build application
        run: npm run build

      # 7ë‹¨ê³„: ë¹Œë“œ ê²°ê³¼ë¬¼ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ (main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰)
  deploy:
    needs: test-and-build # test-and-build ì‘ì—…ì´ ì„±ê³µí•œ í›„ì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # main ë¸Œëœì¹˜ì—ì„œë§Œ ë°°í¬

    steps:
      # 1ë‹¨ê³„: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ë‹¨ê³„: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/

      # 3ë‹¨ê³„: Docker ë¹Œë“œ
      - name: Build Docker image
        run: |
          docker build -t my-react-app .

      # 4ë‹¨ê³„: Docker ì´ë¯¸ì§€ íƒœê·¸
      - name: Tag Docker image
        run: |
          docker tag my-react-app ${{ secrets.REGISTRY_URL }}/my-react-app:latest
          docker tag my-react-app ${{ secrets.REGISTRY_URL }}/my-react-app:${{ github.sha }}

      # 5ë‹¨ê³„: ì¹´ì¹´ì˜¤ í´ë¼ìš°ë“œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
      - name: Login to Kakao Cloud Registry
        run: |
          echo ${{ secrets.REGISTRY_PASSWORD }} | docker login ${{ secrets.REGISTRY_URL }} -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin

      # 6ë‹¨ê³„: Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push Docker image
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/my-react-app:latest
          docker push ${{ secrets.REGISTRY_URL }}/my-react-app:${{ github.sha }}

      # 7ë‹¨ê³„: ì„œë²„ì— ë°°í¬
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            # ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            docker stop my-react-app || true
            docker rm my-react-app || true

            # ìµœì‹  ì´ë¯¸ì§€ í’€
            docker pull ${{ secrets.REGISTRY_URL }}/my-react-app:latest

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d \
              --name my-react-app \
              -p 80:80 \
              --restart unless-stopped \
              ${{ secrets.REGISTRY_URL }}/my-react-app:latest

            # ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
            echo 'ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰'
          "
