name: Kakao CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies with retry
        run: |
          n=0
          exit_code=0
          until [ $n -ge 5 ]
          do
            npm ci
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
              break
            fi
            n=$(($n+1))
            echo "npm ci failed with exit code $exit_code. Retrying in 10 seconds..."
            sleep 10
          done
          if [ $exit_code -ne 0 ]; then
            echo "npm ci failed after 5 attempts."
          fi
          exit $exit_code

      - name: Run linter
        run: npm run lint

      # Test step removed as unrelated to this project structure
      # If tests are added later, uncomment the lines below:
      # - name: Run tests
      #   run: npm run test

      # Create .env file from secret for build time env vars
      - name: Create .env file
        run: echo "${{ secrets.KAKAO_ENV_FILE }}" > .env.local

      - name: Run build
        run: npm run build

      - name: Get current version (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: current_version
        run: |
          if git tag -l "v*" | grep -q "^v"; then
            LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "v0.0.0")
          else
            LATEST_TAG="v0.0.0"
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "í˜„ì¬ ìµœì‹  íƒœê·¸: $LATEST_TAG"

      - name: Calculate new version (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: new_version
        run: |
          LATEST_TAG="${{ steps.current_version.outputs.latest_tag }}"
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix

          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}

          # Determine version bump type
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          else
            BUMP_TYPE="patch"
          fi

          # Calculate new version
          if [[ "$BUMP_TYPE" == "major" ]]; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
          elif [[ "$BUMP_TYPE" == "minor" ]]; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          else
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="$NEW_MAJOR.$NEW_MINOR.$NEW_PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ìƒˆ ë²„ì „: v$NEW_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image (main branch)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            thepromise2025/thefrontmise:latest
            thepromise2025/thefrontmise:v${{ steps.new_version.outputs.new_version }}
          platforms: linux/amd64
          # Add build-args if environment variables needed at build time
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker build (PR only)
        if: github.event_name == 'pull_request'
        run: |
          docker build -t test-image .
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

      - name: Create Git tag (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v${{ steps.new_version.outputs.new_version }}" -m "Release v${{ steps.new_version.outputs.new_version }}"
          git push origin "v${{ steps.new_version.outputs.new_version }}"

      - name: Create GitHub Release (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ steps.new_version.outputs.new_version }}
          name: Release v${{ steps.new_version.outputs.new_version }}
          body: |
            ## ğŸš€ ìƒˆë¡œìš´ ë¦´ë¦¬ì¦ˆ: v${{ steps.new_version.outputs.new_version }}

            ### ğŸ“¦ Docker ì´ë¯¸ì§€ ì‚¬ìš©ë²•
            ```bash
            # ìµœì‹  ë²„ì „
            docker run -p 3000:80 thepromise2025/thefrontmise:latest

            # íŠ¹ì • ë²„ì „ (ê¶Œì¥)
            docker run -p 3000:80 thepromise2025/thefrontmise:v${{ steps.new_version.outputs.new_version }}
            ```

            ### ğŸ”„ ë³€ê²½ì‚¬í•­
            ì´ ë¦´ë¦¬ì¦ˆëŠ” main ë¸Œëœì¹˜ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ í¬í•¨í•©ë‹ˆë‹¤.

            ### ğŸ“‹ ë¹Œë“œ ì •ë³´
            - **ì»¤ë°‹**: ${{ github.sha }}
            - **ì‘ì„±ì**: ${{ github.actor }}
            - **Node.js**: 22.x
            - **í”Œë«í¼**: linux/amd64
          draft: false
          prerelease: false
